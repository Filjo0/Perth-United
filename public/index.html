<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>Perth United Stats</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Libraries (Using v4 for reliable window.ReactQuery access) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@tanstack/react-query@4/build/umd/index.production.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #fff);
            --tg-text: var(--tg-theme-text-color, #000);
            --tg-hint: var(--tg-theme-hint-color, #999);
            --tg-button: var(--tg-theme-button-color, #2481cc);
            --tg-button-text: var(--tg-theme-button-text-color, #fff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #f4f4f4);
        }
        body { font-family: -apple-system, sans-serif; background: var(--tg-secondary-bg); color: var(--tg-text); margin: 0; padding-bottom: 80px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 1. Your Polling Fix (Robust Loading) ---
        const startApp = () => {
            if (!window.React || !window.ReactDOM || !window.ReactQuery) {
                // Keep checking every 50ms until libraries exist
                return setTimeout(startApp, 50); 
            }

            const { useState, useEffect, useMemo } = React;
            const { QueryClient, QueryClientProvider, useQuery } = window.ReactQuery;
            const queryClient = new QueryClient();
            
            // Empty string = Fetch from same domain (Render)
            const API_BASE_URL = ""; 

            // --- 2. UI Components ---

            // Icons (Inline SVG)
            const Icons = {
                Calendar: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
                History: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/><path d="M12 7v5l4 2"/></svg>,
                Users: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
                Trophy: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
            };

            const TabButton = ({ active, label, icon, onClick }) => (
                <button 
                    onClick={onClick}
                    className={`flex-1 py-3 flex flex-col items-center gap-1 border-b-2 transition-all ${
                        active 
                        ? 'border-[var(--tg-button)] text-[var(--tg-button)]' 
                        : 'border-transparent text-[var(--tg-hint)] opacity-70'
                    }`}
                >
                    {icon}
                    <span className="text-[10px] font-bold uppercase tracking-wide">{label}</span>
                </button>
            );

            const FixtureCard = ({ f, isResult }) => {
                const badgeColor = f.division === 'MSL' ? 'bg-blue-100 text-blue-800' : 'bg-amber-100 text-amber-800';
                return (
                    <div className="bg-[var(--tg-bg)] p-4 rounded-xl mb-3 shadow-sm">
                        <div className="flex justify-between items-center mb-3">
                            <span className={`text-[10px] font-bold px-2 py-1 rounded uppercase ${badgeColor}`}>{f.division}</span>
                            <span className="text-xs text-[var(--tg-hint)]">{f.round}</span>
                        </div>
                        <div className="flex justify-between items-center">
                            <div>
                                <div className="text-[10px] text-[var(--tg-hint)] uppercase">Opponent</div>
                                <div className="font-bold text-[var(--tg-text)] text-lg">{f.opponent}</div>
                            </div>
                            {isResult ? (
                                <div className="text-xl font-black px-3 py-1 rounded bg-[var(--tg-secondary-bg)]">{f.score}</div>
                            ) : (
                                <div className="text-right">
                                    <div className="text-lg font-bold text-[var(--tg-button)]">{f.time || f.date_time.split(' ')[1]}</div>
                                    <div className="text-xs text-[var(--tg-hint)]">{f.date_time.split(' ')[0]}</div>
                                </div>
                            )}
                        </div>
                        <div className="mt-3 pt-3 border-t border-gray-100 flex items-center text-xs text-[var(--tg-hint)]">
                            üìç {f.location || 'TBC'}
                        </div>
                    </div>
                );
            };

            const StatsTable = ({ players }) => {
                const [sort, setSort] = useState('goals');
                const sorted = useMemo(() => [...players].sort((a, b) => (b[sort] || 0) - (a[sort] || 0)), [players, sort]);

                const Header = ({ label, id }) => (
                    <th className={`p-3 text-xs font-bold cursor-pointer text-right ${sort === id ? 'text-[var(--tg-button)]' : 'text-[var(--tg-hint)]'}`} onClick={() => setSort(id)}>
                        {label} {sort === id && '‚Üì'}
                    </th>
                );

                return (
                    <div className="bg-[var(--tg-bg)] rounded-xl overflow-hidden shadow-sm">
                        <table className="w-full text-left">
                            <thead className="bg-[var(--tg-secondary-bg)] border-b border-gray-100">
                                <tr>
                                    <th className="p-3 text-xs text-[var(--tg-hint)] uppercase">Player</th>
                                    <Header label="G" id="goals" />
                                    <Header label="A" id="assists" />
                                    <Header label="Apps" id="appearances" />
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                                {sorted.map((p, i) => (
                                    <tr key={i}>
                                        <td className="p-3">
                                            <div className="font-bold text-sm">{p.player_name}</div>
                                            <div className="text-[10px] text-[var(--tg-hint)]">{p.division}</div>
                                        </td>
                                        <td className="p-3 text-sm text-right font-bold">{p.goals}</td>
                                        <td className="p-3 text-sm text-right">{p.assists}</td>
                                        <td className="p-3 text-sm text-right">{p.appearances}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                );
            };

            const LadderTable = ({ ladder, title }) => (
                <div className="bg-[var(--tg-bg)] rounded-xl overflow-hidden shadow-sm mb-6">
                    <div className="bg-[var(--tg-secondary-bg)] px-4 py-2 border-b border-gray-100">
                        <h3 className="text-xs font-bold text-[var(--tg-hint)] uppercase">{title}</h3>
                    </div>
                    <table className="w-full text-left text-sm">
                        <thead>
                            <tr className="text-[var(--tg-hint)] text-xs">
                                <th className="p-3 text-center">#</th>
                                <th className="p-3">Team</th>
                                <th className="p-3 text-center">P</th>
                                <th className="p-3 text-center font-bold text-[var(--tg-text)]">Pts</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-100">
                            {ladder.map((team) => (
                                <tr key={team.Club} className={team.Club.includes('Perth United') ? 'bg-blue-50' : ''}>
                                    <td className="p-3 text-center text-[var(--tg-hint)]">{team.Rank}</td>
                                    <td className="p-3 font-medium truncate max-w-[140px]">{team.Club}</td>
                                    <td className="p-3 text-center text-[var(--tg-hint)]">{team.Played}</td>
                                    <td className="p-3 text-center font-bold">{team.Points}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );

            // --- Main App ---
            function App() {
                const [tab, setTab] = useState('fixtures');
                
                const { data, isLoading, error } = useQuery({
                    queryKey: ['allData'],
                    queryFn: async () => {
                        const res = await fetch(`${API_BASE_URL}/api/stats`);
                        if (!res.ok) throw new Error('Failed to load');
                        return res.json();
                    }
                });

                useEffect(() => {
                    if (window.Telegram?.WebApp) {
                        const tg = window.Telegram.WebApp;
                        tg.ready(); tg.expand();
                        document.documentElement.style.setProperty('--tg-bg', tg.themeParams.bg_color);
                        document.documentElement.style.setProperty('--tg-text', tg.themeParams.text_color);
                        document.documentElement.style.setProperty('--tg-hint', tg.themeParams.hint_color);
                        document.documentElement.style.setProperty('--tg-button', tg.themeParams.button_color);
                        document.documentElement.style.setProperty('--tg-button-text', tg.themeParams.button_text_color);
                        document.documentElement.style.setProperty('--tg-secondary-bg', tg.themeParams.secondary_bg_color);
                    }
                }, []);

                if (isLoading) return <div className="flex h-screen items-center justify-center text-[var(--tg-hint)]">Loading Stats...</div>;
                if (error) return <div className="p-8 text-red-500 text-center">Error loading data.</div>;

                const fixtures = data?.fixtures || [];
                // Logic: If score contains numbers (e.g. "3 - 1"), it's a Result. Otherwise it's Upcoming.
                const upcoming = fixtures.filter(f => !String(f.score || '').match(/\d+\s*-\s*\d+/));
                const results = fixtures.filter(f => !upcoming.includes(f)).reverse();

                return (
                    <div>
                        {/* Sticky Header */}
                        <div className="sticky top-0 z-10 bg-[var(--tg-bg)]/95 backdrop-blur-sm shadow-sm border-b border-gray-100 mb-4 -mx-4 px-4 pt-2">
                            <div className="flex justify-between">
                                <TabButton active={tab === 'fixtures'} label="Fixtures" icon={<Icons.Calendar/>} onClick={() => setTab('fixtures')} />
                                <TabButton active={tab === 'results'} label="Results" icon={<Icons.History/>} onClick={() => setTab('results')} />
                                <TabButton active={tab === 'stats'} label="Stats" icon={<Icons.Users/>} onClick={() => setTab('stats')} />
                                <TabButton active={tab === 'ladder'} label="Table" icon={<Icons.Trophy/>} onClick={() => setTab('ladder')} />
                            </div>
                        </div>

                        {/* Tabs */}
                        <div className="animate-fade-in">
                            {tab === 'fixtures' && (
                                <div>
                                    {upcoming.length === 0 && <div className="text-center text-[var(--tg-hint)] mt-10">No upcoming games.</div>}
                                    {upcoming.map(f => <FixtureCard key={f.id} f={f} />)}
                                </div>
                            )}

                            {tab === 'results' && (
                                <div>
                                    {results.length === 0 && <div className="text-center text-[var(--tg-hint)] mt-10">No past results.</div>}
                                    {results.map(f => <FixtureCard key={f.id} f={f} isResult />)}
                                </div>
                            )}

                            {tab === 'stats' && <StatsTable players={data?.players || []} />}
                            
                            {tab === 'ladder' && (
                                <div>
                                    <LadderTable ladder={data?.msl_ladder || []} title="Men's Supa-Liga (A)" />
                                    <LadderTable ladder={data?.mslb_ladder || []} title="Men's Supa-Liga (B)" />
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<QueryClientProvider client={queryClient}><App /></QueryClientProvider>);
        };

        // Execute Polling Logic
        startApp();
    </script>
</body>
</html>

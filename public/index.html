<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no, user-scalable=no" />
    <title>Perth United Stats</title>

    <!-- 1. Telegram Mini App Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!--
      All other scripts are MOVED from the <head> to the <body>
      to prevent the race condition.
    -->

    <!-- 5. Simple Styling -->
    <style>
        :root {
            --tg-bg: #ffffff;
            --tg-text: #000000;
            --tg-hint: #999999;
            --tg-button: #2481cc;
            --tg-button-text: #ffffff;
            --tg-secondary-bg: #f4f4f4;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--tg-bg);
            color: var(--tg-text);
            margin: 0;
            padding: 15px;
            box-sizing: border-box;
        }
        .container { max-width: 600px; margin: 0 auto; }
        .card {
            background: var(--tg-secondary-bg);
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 12px;
        }
        .card h3 { margin: 0 0 8px 0; font-size: 1.1em; }
        .card p { margin: 0; font-size: 0.9em; color: var(--tg-hint); }
        .card .stats { color: var(--tg-text); font-weight: 500; }

        .loading { text-align: center; padding: 40px; color: var(--tg-hint); font-weight: 500; }
        .error { text-align: center; padding: 40px; color: #E53E3E; font-weight: 500; }

        .nav { display: flex; gap: 8px; margin-bottom: 16px; }
        .nav button {
            flex: 1; padding: 12px; border: none;
            background: var(--tg-secondary-bg);
            color: var(--tg-text);
            border-radius: 8px; font-weight: bold; font-size: 1em;
            cursor: pointer;
        }
        .nav button.active {
            background: var(--tg-button);
            color: var(--tg-button-text);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!--
      *** THIS IS THE FIX ***
      All library scripts are moved here, at the end of the <body>.
      The browser will load and execute them in this exact order
      before it reaches your main application script.
    -->
    <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tanstack/react-query@5/dist/umd/react-query.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!--
      Your app script now runs last, *after* React and ReactQuery are guaranteed to be loaded.
    -->
    <script type="text/babel">
        // --- Setup ---
        const { useState, useEffect, useMemo } = React;

        // This line is now safe because the library scripts above have finished loading.
        const { QueryClient, QueryClientProvider, useQuery } = window.ReactQuery;

        const queryClient = new QueryClient();

        // This tells the app to fetch from the same domain
        const API_BASE_URL = "";

        // --- API Fetching Functions ---
        const fetchAllStats = async () => {
            const res = await fetch(`${API_BASE_URL}/api/stats`);
            if (!res.ok) throw new Error('Network response was not ok');
            return res.json();
        };

        // --- React Components ---
        function PlayerStats() {
            const { data, isLoading, error } = useQuery({
                queryKey: ['stats'],
                queryFn: fetchAllStats
            });

            const [sortBy, setSortBy] = useState('goals');

            if (isLoading) return <div className="loading">Loading Players...</div>;
            if (error) return <div className="error">Error loading stats: {error.message}</div>;

            const players = data?.players || [];

            const sortedPlayers = useMemo(() => {
                return [...players].sort((a, b) => {
                    // Use .get() for safety, defaulting to 0
                    return (b[sortBy] || 0) - (a[sortBy] || 0);
                });
            }, [players, sortBy]);

            return (
                <div>
                    <div className="nav">
                        <button className={sortBy === 'goals' ? 'active' : ''} onClick={() => setSortBy('goals')}>Goals</button>
                        <button className={sortBy === 'assists' ? 'active' : ''} onClick={() => setSortBy('assists')}>Assists</button>
                        <button className={sortBy === 'appearances' ? 'active' : ''} onClick={() => setSortBy('appearances')}>Apps</button>
                    </div>
                    {sortedPlayers.length === 0 && <div className="card"><p>No player stats found.</p></div>}
                    {sortedPlayers.map((player, i) => (
                        <div key={player.player_name + player.division} className="card">
                            <h3>[{player.division}] {player.player_name}</h3>
                            <p className="stats">
                                <strong>Goals:</strong> {player.goals} |
                                <strong> Assists:</strong> {player.assists} |
                                <strong> Apps:</strong> {player.appearances}
                            </p>
                        </div>
                    ))}
                </div>
            );
        }

        function FixturesCalendar() {
             const { data, isLoading, error } = useQuery({
                queryKey: ['stats'], // Use the same 'stats' query
                queryFn: fetchAllStats
            });

            if (isLoading) return <div className="loading">Loading Fixtures...</div>;
            if (error) return <div className="error">Error loading fixtures: {error.message}</div>;

            const fixtures = data?.fixtures || [];

            // Filter for upcoming games (logic moved from backend to frontend)
            const upcoming = useMemo(() => {
                return fixtures.filter(f => {
                    const score_str = String(f.score || '').trim().toLowerCase();
                    const isPlayed = score_str.match(/\d+\s*-\s*\d+/); // Matches "3 - 1"
                    return !isPlayed;
                });
            }, [fixtures]);

            return (
                <div>
                    {upcoming.length === 0 && (
                        <div className="card">
                            <p>No upcoming fixtures found.</p>
                        </div>
                    )}
                    {upcoming.map((f, i) => (
                         <div key={f.id || i} className="card">
                            <h3>[{f.division}] Round {f.round}</h3>
                            <p><strong>vs {f.opponent}</strong></p>
                            <p className="stats">{f.date_time} at {f.location || 'TBC'}</p>
                        </div>
                    ))}
                </div>
            );
        }

        function App() {
            const [view, setView] = useState('fixtures'); // Default to fixtures

            useEffect(() => {
                try {
                    const tg = window.Telegram.WebApp;
                    tg.ready();

                    document.documentElement.style.setProperty('--tg-bg', tg.themeParams.bg_color || '#ffffff');
                    document.documentElement.style.setProperty('--tg-text', tg.themeParams.text_color || '#000000');
                    document.documentElement.style.setProperty('--tg-hint', tg.themeParams.hint_color || '#999999');
                    document.documentElement.style.setProperty('--tg-button', tg.themeParams.button_color || '#2481cc');
                    document.documentElement.style.setProperty('--tg-button-text', tg.themeParams.button_text_color || '#ffffff');
                    document.documentElement.style.setProperty('--tg-secondary-bg', tg.themeParams.secondary_bg_color || '#f4f4f4');

                    tg.expand();
                } catch (e) {
                    console.warn("Telegram WebApp API not found. Running in browser mode.");
                }
            }, []);

            return (
                <div className="container">
                    <div className="nav">
                        <button
                            className={view === 'fixtures' ? 'active' : ''}
                            onClick={() => setView('fixtures')}>
                            Fixtures
                        </button>
                        <button
                            className={view === 'stats' ? 'active' : ''}
                            onClick={() => setView('stats')}>
                            Player Stats
                        </button>
                    </div>

                    {view === 'fixtures' ? <FixturesCalendar /> : <PlayerStats />}
                </div>
            );
        }

        // --- Mount the App ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <QueryClientProvider client={queryClient}>
                <App />
            </QueryClientProvider>
        );
    </script>
</body>
</html>